#!/bin/sh

# Fail on error
set -e
# Echo commands
set -x

REQUIRE_DEV=`jq '.["require-dev"]|keys|.[]' --raw-output < composer.json`
REQUIRE=`jq '.["require"]|keys|.[]' --raw-output < composer.json`

# Use --no-scripts throughout to prevent phar-install from running

composer remove --no-scripts --dev ${REQUIRE_DEV}
composer remove --no-scripts ${REQUIRE}

# Removing these is required for composer to use the latest versions
rm -rf composer.lock vendor/

composer require --no-scripts --dev ${REQUIRE_DEV}
composer require --no-scripts ${REQUIRE}

# Run a final update without --no-scripts to allow phar-install to run
composer update
